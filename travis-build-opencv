#!/bin/bash
set -eux -o pipefail

#OPENCV_VERSION=3.1.0
OPENCV_VERSION=${OPENCV_VERSION:-3.2.0}

#GRAPHICAL=ON
GRAPHICAL=${GRAPHICAL:-OFF}

# OpenCV looks for libjpeg in /usr/lib/libjpeg.so, for some reason. However,
# it does not seem to be there in 14.04. Create a link

mkdir -p $HOME/usr/lib

if [[ ! -f "$HOME/usr/lib/libjpeg.so" ]]; then
  ln -s /usr/lib/x86_64-linux-gnu/libjpeg.so $HOME/usr/lib/libjpeg.so
fi

# Same for libpng.so

if [[ ! -f "$HOME/usr/lib/libpng.so" ]]; then
  ln -s /usr/lib/x86_64-linux-gnu/libpng.so $HOME/usr/lib/libpng.so
fi

# Build OpenCV
if [[ ! -e "$HOME/usr/installed" ]]; then
if [[ ! -d "opencv-${OPENCV_VERSION}/build" ]]; then
  curl -sL https://github.com/Itseez/opencv/archive/${OPENCV_VERSION}.zip > opencv.zip
  unzip -q opencv.zip
  mkdir opencv-${OPENCV_VERSION}/build
fi

if [[ ! -d "opencv_contrib-${OPENCV_VERSION}/modules" ]]; then
   curl -sL https://github.com/opencv/opencv_contrib/archive/${OPENCV_VERSION}.zip > opencv-contrib.zip
   unzip -q opencv-contrib.zip
fi

cd opencv-${OPENCV_VERSION}/build
cmake -D WITH_IPP=${GRAPHICAL} \
      -D WITH_OPENGL=${GRAPHICAL} \
      -D WITH_QT=${GRAPHICAL} \
      -D BUILD_EXAMPLES=OFF \
      -D BUILD_TESTS=OFF \
      -D BUILD_PERF_TESTS=OFF  \
      -D BUILD_opencv_java=OFF \
      -D BUILD_opencv_python=OFF \
      -D BUILD_opencv_python2=OFF \
      -D BUILD_opencv_python3=OFF \
      -D CMAKE_INSTALL_PREFIX=$HOME/usr \
      -D OPENCV_EXTRA_MODULES_PATH=../../opencv_contrib-${OPENCV_VERSION}/modules ..
make -j8
make install && touch $HOME/usr/installed
cd ../..
touch $HOME/fresh-cache
fi

